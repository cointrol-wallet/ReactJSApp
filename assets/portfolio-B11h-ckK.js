import{a as s,b as de,j as e}from"./vendor-react-C4KqQK9E.js";import{u as Oe,s as ze}from"./useFolioList-CymrOcEm.js";import{u as We}from"./useCoinList-CHGj9T2_.js";import{a as Ze,s as He,b as Ue,c as _e,d as $e}from"./index-BRJ5KNqN.js";import{u as Qe}from"./useDomains-BQM1XWa_.js";import{d as Ye,h as qe,j as Ke}from"./vendor-viem-BanhIei1.js";import{S as Ge,d as Je}from"./shareBuilders-xyKEJt4z.js";import"./vendor-qr-BZDEmg8j.js";import"./vendor-firebase-CrtqWl9v.js";function Ve(o){return o.type==="NATIVE"||o.address==="0x0"}async function Xe(o){const{folios:a,coins:y,domains:j}=o,m=new Map,b=new Map;for(const u of y){const p=b.get(u.chainId)??[];p.push(u),b.set(u.chainId,p)}const N=new Map;for(const u of a){const p=N.get(u.chainId)??[];p.push(u),N.set(u.chainId,p)}for(const[u,p]of N.entries()){const L=j.find(v=>v.chainId===u)?.rpcUrl;if(!L)continue;const I=Ye({transport:qe(L)}),G=b.get(u)??[];for(const v of p){const H=v.address;let M;const R=new Set((v.wallet??[]).map(f=>f.coin));if(M=G.filter(f=>R.has(f.id)),M.length===0)continue;const g=[];for(const f of M)try{if(Ve(f)){const c=await I.getBalance({address:H});g.push({coin:f.id,balance:c})}else if(f.type==="ERC20"){const c=await I.readContract({address:f.address,abi:Ke,functionName:"balanceOf",args:[H]});g.push({coin:f.id,balance:c})}else{const c=(v.wallet??[]).find(k=>k.coin===f.id);c&&g.push(c)}}catch{const c=(v.wallet??[]).find(k=>k.coin===f.id);c&&g.push(c)}m.set(v.id,g)}}return m}const ve="cointrol:profile:displayName:v1",le=new Set;function et(o){for(const a of le)a(o)}function tt(o){return le.add(o),je().then(a=>o(a)),()=>le.delete(o)}async function je(){return(await Ze(ve)??"").trim()}async function st(o){const a=o.trim();await He(ve,a),et(a)}function nt(){const[o,a]=s.useState("");s.useEffect(()=>{let j=!0;je().then(b=>{j&&a((b??"").toString())});const m=tt(b=>{a((b??"").toString())});return()=>{j=!1,m()}},[]);const y=s.useCallback(async j=>{const m=(j??"").trim();await st(m),a(m)},[]);return{displayName:o,save:y}}function ot({open:o,initialValue:a,onClose:y,onSave:j}){const[m,b]=s.useState(a??""),[N,u]=s.useState(!1);if(s.useEffect(()=>{o&&b(a??"")},[o,a]),!o||typeof document>"u")return null;const p=(m??"").trim(),L=p.length>=2;return de.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:y,style:{position:"fixed",inset:0,zIndex:2147483646,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(6px)"}}),e.jsxs("div",{role:"dialog","aria-modal":"true",className:`
    rounded-2xl
    border border-neutral-200
    bg-[#fffdf7]        /* soft ivory */
    text-neutral-900
    shadow-2xl
    backdrop-blur-none
  `,style:{position:"fixed",zIndex:2147483647,top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"min(420px, calc(100vw - 32px))",padding:20},onClick:I=>I.stopPropagation(),children:[e.jsx("div",{className:"text-lg font-semibold",children:"Set display name"}),e.jsx("div",{className:"mt-1 text-sm text-neutral-600",children:"Set the name used for profile sharing"}),e.jsx("input",{className:"mt-3 w-full rounded border px-3 py-2",value:m,onChange:I=>b(I.target.value),placeholder:"e.g. Paul Bark",autoFocus:!0}),e.jsx("div",{className:"mt-4 flex justify-end gap-2"}),e.jsx("br",{}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"h-9 rounded-md border border-border bg-card px-3 text-sm hover:bg-muted",onClick:y,disabled:N,children:" Cancel "})," ",e.jsxs("button",{type:"button",className:"h-9 rounded-md bg-primary px-3 text-sm text-primary-foreground",disabled:!L||N,onClick:async()=>{u(!0);try{await j(p),y()}finally{u(!1)}},children:[" ",N?"Saving…":"Save"," "]})]})]})]}),document.body)}function xt(){const[o,a]=s.useState(""),[y,j]=s.useState("nameAsc"),[m,b]=s.useState("coinBalanceDesc"),[N,u]=s.useState([]),[p,L]=s.useState("any"),[I,G]=s.useState(""),[v,H]=s.useState(11155111),[M,R]=s.useState(!1),[g,f]=s.useState(null),[c,k]=s.useState(null),[we,U]=s.useState(null),[S,Ne]=s.useState(null),[ce,J]=s.useState(""),V={1:"Ethereum",11155111:"Sepolia"},{coins:E,loading:_,error:$}=We({query:o,sortMode:"nameAsc",tags:N,tagMode:p,standard:"",chainId:v}),{folios:x,loading:z,error:T,addFolio:Se,deleteFolio:Ce,updateFolio:X}=Oe({query:o,sortMode:"createdAsc",chainId:v}),{domains:W,loading:Q,error:Y}=Qe(),{displayName:ee,save:Ie}=nt(),[ke,te]=s.useState(!1),[ue,me]=s.useState(null);async function Ae(){const t=(ee??"").trim();if(!t){te(!0);return}const n=Je(t,x);me(n)}const fe=s.useMemo(()=>{const t=[];for(const n of x){const d=n.wallet?.length??0;if(d>0)for(let r=0;r<d;r++)t.push({folioId:n.id,coinId:n.wallet?.[r]?.coin??"",walletId:r});else t.push({folioId:n.id,coinId:"",walletId:-1})}return t},[x,E]);s.useEffect(()=>{function t(n){n.target.closest("details")||document.querySelectorAll("details[open]").forEach(r=>{r.removeAttribute("open")})}return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),s.useEffect(()=>{c!=null&&U(x.find(t=>t.id===c)?.name||null)},[c,x]),s.useEffect(()=>{if(!M)return;const t=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=t}},[M]);const xe=s.useMemo(()=>ze(fe,x,E,y,m),[fe,x,E,y,m]);function De(t,n){if(n<=0)return t.toString();const d=t<0n,r=d?-t:t,C=10n**BigInt(n),P=r/C;let l=(r%C).toString().padStart(n,"0");l=l.replace(/0+$/,"");const h=P.toString()+(l.length>0?"."+l:"");return d?"-"+h:h}const se=s.useRef(!1),[pe,he]=s.useState(!1),be=s.useRef(!1),ne=s.useCallback(async()=>{if(!se.current&&!(z||_||Q)&&!(T||$||Y)&&x.length){se.current=!0,he(!0);try{const t=await Xe({folios:x,coins:E,domains:W});for(const[n,d]of t.entries())await X(n,{wallet:d})}finally{se.current=!1,he(!1)}}},[z,_,Q,T,$,Y,x,E,W,X]);s.useEffect(()=>{be.current||z||_||Q||T||$||Y||x.length&&(be.current=!0,ne())},[z,_,Q,T,$,Y,x,ne]);function Me({primarySortMode:t,setPrimarySortMode:n,secondarySortMode:d,setSecondarySortMode:r,tagSearch:w,setTagSearch:C,setTags:P,tagMode:B,setTagSearchMode:l}){const[h,ye]=s.useState(!1),oe=s.useRef(null),[re,Le]=s.useState({top:0,left:0,width:320}),ae=()=>ye(!1),O=s.useCallback(()=>{if(!oe.current)return;const i=oe.current.getBoundingClientRect(),D=8,Z=Math.min(360,window.innerWidth-D*2),ie=i.bottom+8,Te=i.right-Z,Be=Math.min(Math.max(D,Te),window.innerWidth-Z-D);Le({top:ie,left:Be,width:Z})},[]),Re=()=>{const i=!h;i&&O(),ye(i)};return s.useEffect(()=>{if(!h)return;const i=D=>{D.key==="Escape"&&ae()};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[h]),s.useEffect(()=>{if(h)return window.addEventListener("resize",O),window.addEventListener("scroll",O,!0),()=>{window.removeEventListener("resize",O),window.removeEventListener("scroll",O,!0)}},[h,O]),e.jsxs(e.Fragment,{children:[e.jsx("button",{ref:oe,type:"button",className:"h-9 whitespace-nowrap rounded-md border border-border bg-card px-3 text-sm text-foreground",onClick:Re,children:" Sort / Filter "}),h&&typeof document<"u"&&de.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:ae,style:{position:"fixed",inset:0,zIndex:9998,background:"rgba(0,0,0,0.35)"}}),e.jsxs("div",{className:"rounded-xl border border-border bg-card shadow-lg",style:{position:"fixed",zIndex:9999,top:re.top,left:re.left,width:re.width,padding:12},onClick:i=>i.stopPropagation(),children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Sort"}),e.jsxs("select",{className:"h-9 w-full rounded-md border border-border bg-background px-2 text-sm text-foreground",value:t,onChange:i=>n(i.target.value),children:[e.jsx("option",{value:"nameAsc",children:"Name (A → Z)"}),e.jsx("option",{value:"nameDesc",children:"Name (Z → A)"}),e.jsx("option",{value:"symbolAsc",children:"Symbol (A → Z)"}),e.jsx("option",{value:"symbolDesc",children:"Symbol (Z → A)"}),e.jsx("option",{value:"chainIdAsc",children:"Chain ID (Low → High)"}),e.jsx("option",{value:"chainIdDesc",children:"Chain ID (High → Low)"}),e.jsx("option",{value:"createdDesc",children:"Newest first"}),e.jsx("option",{value:"createdAsc",children:"Oldest first"})]}),e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Sort"}),e.jsxs("select",{className:"h-9 w-full rounded-md border border-border bg-background px-2 text-sm text-foreground",value:d,onChange:i=>r(i.target.value),children:[e.jsx("option",{value:"nameAsc",children:"Name (A → Z)"}),e.jsx("option",{value:"nameDesc",children:"Name (Z → A)"}),e.jsx("option",{value:"symbolAsc",children:"Symbol (A → Z)"}),e.jsx("option",{value:"symbolDesc",children:"Symbol (Z → A)"}),e.jsx("option",{value:"chainIdAsc",children:"Chain ID (Low → High)"}),e.jsx("option",{value:"chainIdDesc",children:"Chain ID (High → Low)"}),e.jsx("option",{value:"createdDesc",children:"Newest first"}),e.jsx("option",{value:"createdAsc",children:"Oldest first"})]}),e.jsx("div",{className:"my-3 border-t border-border"}),e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Filter by tags"}),e.jsx("input",{className:"h-9 w-full rounded-md border border-border bg-background px-2 text-sm text-foreground placeholder:text-muted",placeholder:"Comma-separated tags…",value:w,onChange:i=>{const D=i.target.value;C(D);const Z=D.split(",").map(ie=>ie.trim()).filter(Boolean);P(Z)}}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted",children:"Mode"}),e.jsxs("select",{className:"h-9 flex-1 rounded-md border border-border bg-background px-2 text-sm text-foreground",value:B,onChange:i=>l(i.target.value),children:[e.jsx("option",{value:"any",children:"Match any"}),e.jsx("option",{value:"all",children:"Match all"})]}),e.jsx("button",{type:"button",className:"h-9 rounded-md border border-border bg-card px-3 text-sm hover:bg-muted",onClick:()=>{C(""),P([]),l("any")},children:"Clear"})]}),e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx("button",{type:"button",className:"h-9 rounded-md bg-primary px-3 text-sm text-primary-foreground",onClick:ae,children:"Done"})})]})]}),document.body)]})}function ge(){J("")}function Ee(){if(!S)return;ge(),x.filter(n=>n.chainId===S.chainId).length===0&&R(!0)}function Fe(t){f(t),J(t.name??""),R(!0)}function q(){R(!1),f(null),A({status:"idle"}),ge()}const[F,A]=s.useState({status:"idle"}),K=F.status==="pending";s.useEffect(()=>{!S&&W.length&&Ne(W[0])},[S,W]);async function Pe(t){t.preventDefault();const n=ce.trim();if(!n)return;const d={name:n};try{if(A({status:"pending",message:g?"Saving changes…":"Submitting account creation…"}),g)await X(g.id,d);else{const r=await Ue();if(!r){A({status:"error",message:"No user UUID found. Account creation is not possible."});return}const w=await _e(r,512);if(!w){A({status:"error",message:"No sender address available for new account."});return}if(A({status:"pending",message:"Creating QuantumAccount (waiting for bundler)…"}),!await $e({sender:w,domain:S.name,salt:r})){A({status:"error",message:"Account creation failed (no wallet returned)."});return}A({status:"pending",message:"Finalising and saving to your portfolio…"});const B=E.filter(h=>h.chainId===S.chainId).map(h=>({coin:h.id,balance:0n})),l={address:w,chainId:S.chainId,paymaster:S.paymaster,type:0,bundler:S.bundler,wallet:B};await Se({...d,...l})}q()}catch(r){const w=typeof r?.message=="string"?r.message:"Something went wrong while creating the account.";A({status:"error",message:w})}}return z?e.jsx("div",{className:"p-4",children:"Loading coins…"}):T?e.jsx("div",{className:"p-4 text-red-600",children:T}):e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx("h1",{className:"shrink-0 text-2xl leading-tight font-semibold text-foreground",children:"Portfolio"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("select",{className:"h-9 w-[140px] rounded-md border border-border bg-card px-2 text-sm text-foreground",value:v,onChange:t=>H(Number(t.target.value)),children:Object.entries(V).map(([t,n])=>e.jsx("option",{value:t,children:n},t))}),e.jsx("input",{className:"h-9 w-full rounded-md border border-border bg-card px-2 text-sm text-foreground placeholder:text-muted sm:max-w-md",placeholder:"Search by name or address…",value:o,onChange:t=>a(t.target.value)}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-2",children:[e.jsx(Me,{primarySortMode:y,setPrimarySortMode:j,secondarySortMode:m,setSecondarySortMode:b,tagSearch:I,setTagSearch:G,setTags:u,tagMode:p,setTagSearchMode:L})," ",e.jsx("button",{className:"h-9 rounded-md border border-border bg-card px-3 text-sm",onClick:Ee,children:" Create account "}),e.jsxs("button",{className:"h-9 rounded-md border border-border bg-card px-3 text-sm disabled:opacity-50",onClick:ne,disabled:pe,children:[" ",pe?"Refreshing…":"Refresh balances"," "]}),e.jsxs("button",{type:"button",className:"h-9 rounded-md border border-border bg-card px-3 text-sm ",onClick:t=>{t.preventDefault(),t.stopPropagation(),R(!1),k(null),U(null),te(!0)},children:[" ",ee?"Edit display name":"Set display name"," "]}),e.jsx("button",{type:"button",className:"h-9 rounded-md border border-border bg-card px-3 text-sm ",onClick:t=>{t.preventDefault(),t.stopPropagation(),Ae()},children:" Share profile "})]})]}),e.jsx(ot,{open:ke,initialValue:ee??"",onClose:()=>te(!1),onSave:Ie}),xe.length===0?e.jsx("div",{className:"text-sm text-muted",children:'No accounts created yet. Click "Create account" to get started.'}):e.jsx("ul",{className:"space-y-2",children:xe.map(t=>{const n=x.find(l=>l.id===t.folioId),d=E.find(l=>l.id===t.coinId),r=n?.wallet?.[t.walletId],w=n?.name??t.folioId,C=d?.symbol??"—",P=n&&V[n.chainId]?V[n.chainId]:n?`Chain ${n.chainId}`:"Unknown chain",B=r&&d?De(r.balance,d.decimals):"0";return e.jsx("li",{className:"w-full",children:e.jsx("div",{className:"w-full rounded-lg border border-border bg-card px-4 py-3",children:e.jsxs("div",{className:"grid gap-3 sm:gap-x-6 sm:gap-y-2 sm:grid-cols-[160px_90px_minmax(0,1fr)_110px] sm:items-start",children:[e.jsx("div",{className:"min-w-0 font-medium",children:w}),e.jsx("div",{className:"min-w-0 text-xs text-muted-foreground sm:pt-1",children:C}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:P}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Balance: ",B," ",C]})]}),e.jsx("div",{className:"justify-self-start sm:justify-self-end",children:e.jsxs("details",{className:"relative inline-block",children:[e.jsx("summary",{className:"cursor-pointer list-none rounded-md border border-border bg-background px-2 py-1 text-xs",children:"Actions"}),e.jsxs("div",{className:"absolute left-0 sm:right-0 sm:left-auto mt-1 w-40 rounded-md border border-border bg-background shadow-lg z-50",children:[e.jsx("button",{className:"block w-full px-3 py-2 text-left text-xs hover:bg-muted",onClick:l=>{l.currentTarget.closest("details")?.removeAttribute("open"),n&&Fe(n)},children:"Edit"}),e.jsx("div",{className:"my-1 border-t border-border"}),e.jsx("button",{className:"block w-full px-3 py-2 text-left text-xs text-red-600 hover:bg-muted",onClick:l=>{l.currentTarget.closest("details")?.removeAttribute("open"),k(t.folioId)},children:"Remove"})]})]})})]})})},`${t.folioId}-${t.coinId}-${t.walletId}`)})}),M?de.createPortal(e.jsx("div",{className:"bg-background/80 backdrop-blur-sm",onClick:t=>{t.target===t.currentTarget&&q()},style:{position:"fixed",inset:0,zIndex:2147483647,display:"flex",alignItems:"center",justifyContent:"center",padding:16},children:e.jsxs("div",{className:"bg-background",onMouseDown:t=>t.stopPropagation(),style:{width:"100%",maxWidth:448,borderRadius:12,padding:16,boxShadow:"0 10px 30px rgba(0,0,0,0.3)"},children:[e.jsx("h2",{className:"mb-3 text-base font-semibold",children:g?"Change Label":"Create Account"}),e.jsxs("form",{className:"space-y-4",onSubmit:Pe,children:[F.status!=="idle"&&e.jsxs("div",{className:`rounded-md border px-3 py-2 text-xs ${F.status==="error"?"border-red-300":"border-border"}`,children:[F.status==="pending"&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{children:F.message})}),F.status==="error"&&e.jsx("div",{className:"text-red-600",children:F.message})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-medium",children:"Name"}),e.jsx("input",{className:"w-full rounded-md border px-2 py-1 text-sm",value:ce,onChange:t=>J(t.target.value),required:!0,disabled:K})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",className:"rounded-md border px-3 py-1 text-xs",onClick:q,disabled:K,children:" Cancel "})," ",e.jsxs("button",{type:"submit",className:"rounded-md bg-primary px-3 py-1 text-xs font-medium text-background",disabled:K,children:[" ",K?g?"Saving…":"Creating…":g?"Save changes":"Create account"," "]})]})]})]})}),document.body):null,c&&e.jsx("div",{onClick:t=>{t.target===t.currentTarget&&q()},style:{position:"fixed",inset:0,zIndex:2147483647,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(6px)",overflowY:"auto",WebkitOverflowScrolling:"touch",padding:16,minHeight:"100dvh",display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsxs("div",{onClick:t=>t.stopPropagation(),style:{width:"min(448px, calc(100dvw - 32px))",borderRadius:12,padding:16,boxShadow:"0 10px 30px rgba(0,0,0,0.3)",background:"#fff",color:"#111",maxHeight:"calc(100dvh - 32px)",overflowY:"auto"},children:[e.jsx("h2",{className:"text-base font-semibold",children:"Delete account?"}),e.jsxs("p",{className:"mt-2 text-sm text-muted",children:["This will remove the entire portfolio account ",e.jsx("strong",{children:we||"unnamed"})," and its balances from your list. This action cannot be undone and you could lose access to your assets. If you just want to remove the coin balance then go to the coin page and delete the coin."]}),e.jsxs("div",{className:"mt-4 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",children:[e.jsx("button",{className:"rounded-md border px-3 py-1 text-sm",onClick:()=>{k(null),U(null)},children:" Cancel "})," ",e.jsx("button",{className:"rounded-md bg-primary px-3 py-1 text-sm text-background",onClick:()=>{c&&Ce(c),k(null),U(null)},children:" Yes, delete account "})]})]})}),ue&&e.jsx(Ge,{payload:ue,onClose:()=>me(null)})]})}export{xt as Folios};
